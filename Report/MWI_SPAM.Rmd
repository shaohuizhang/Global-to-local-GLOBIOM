---
title: "Global-to-local GLOBIOM procedure"
author: "Michiel van Dijk"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: 
  word_document:
    reference_docx: ../Common/word_styles_01.docx
    
---

```{r setup, include=FALSE}
library(pacman)
p_load(rprojroot)
root <- find_root(is_rstudio_project)

p_load(knitr)
knitr::opts_chunk$set(
  fig.width=12, fig.height=8,
  dpi = 300,
  echo=FALSE, warning=FALSE, message=FALSE,
  fig.path = file.path(root,"FigTabMap/out-"),
  dev = "CairoPNG",
  dev.args = list(CairoPNG = list(bg = "transparent"))
  )

p_load(pander)
panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

#source(file.path(root, "Code/Fig_cs.R"))
#source(file.path(root, "Code/Tab_cs.R"))
#source(file.path(root, "Code/Map_cs.R"))
```

# Introduction
- SPAM, MIRCA, etc exists [@ref comparison paper].
- Good for global modelling but for country case studies [@Rutten2014] detailed land use maps are often needed. Stakeholders might provide additional information on location of certain crops or irrigated areas that need to be incorporated in the final map.
- Case stuyd on national land use map construction. Follows SPAM but adds additional data.
- Make use of national and very detaitled land cover maps at high resolution. ALready present location of three crops. Still have to spatially allocate others. 
- Collect detailed information on irrigated areas and construct new irrigation map that are crop specific. Improvement over GMIA that only shows irrigated areas. 
- Crop statistics at adm2 
- Validation using households survey

# The spatial production allocation model

The spatial allocation model we use in this paper builds on the SPAM model presented in @You2014. SPAM uses a cross entropy framework to allocate aggregate land use information to grid cells. An objective function that expresses land allocation shares as probabilities is minimized subject to a set of constraints that capture the available information on location of certain crops and crop systems (e.g. crop cover and irrigation maps) or the likelihood a crop is grown in a certain area (e.g. suitability maps and subnational land use statistics). Although @You2014 use country specific data sources for subnational land use statistics, they mainly rely on global sources to define the land allocation constraints. In this study, we were able to collect more detailed information, which allowed us to refine the allocation procedure. In particular, we collected a high resolution land cover map, which reveals the location of five crop groups and created new crop specific irrigation maps for Malawi. [@PERHAPS UPDATE OF SUITABILITY MAPS]. In the sections below we present the adjusted SPAM model as well as the calculation of priors, which are needed to start the cross entropy optimization. To remain comparability with @You2014, we use the same variable names and indices.


## Cross entropy framework and constraints
For the cross entropy framework can be implemented, the allocated area needs to be converted into a probability with value between 0 and 1. This is done as follows:

$$ s_{ijl} = \frac{A_{ijl}} {CropArea_{jl}}$$
where, $s_{ijl}$ is the area share allocated to grid cell identifier $i = 1,2,3,...$ and crop identifier $j = maize, cassave, rice,...$ at input level $l=irrigated, rainfed-high input, subsistence$. $A_{ijl}$ is the area allocated to grid cell $i$ for crop $j$ at input level $l$. $CropArea_{jl}$ is the total physical crop area in Malawi for crop $j$ at input level $l$.

The spatial allocation model can then be defined as a non-linear optimization problem in which the error between prior information on allocated area shares ({$\pi_{ij}$) and allocated area shares ($s_{ijl}$) is minimized, subject to a set of constraints. The objective function is defined as follows:

$$\min_{s_{ijl}} \quad CE(s_{ijl}, \pi_{ijl})= \sum_{i} \sum_{j} \sum_{l}s_{ijl} \ lns_{ijl}- \sum_{i} \sum_{j} \sum_{l}s_{ijl} \ ln\pi_{ijl}  $$
subject to:

(i) A constraint defining the range of permitted physical area shares:

$$0 \leq s_{ijl} \leq 1$$

(ii) A constraint (@X), which ensures  ensures that the sum of allocated physical area shares within grid cells sum to one. This ensures all physical crop area is allocated to grid cells. 

$$\sum_{i}s_{ij}=1 \qquad \forall j \quad \forall l$$

(iii) A constraint, which specifies that the sum of allocated physical area for each crop group, $c=rice, tropical \, fruits, sugar \, cane,...,$ and production systems is lower or equal than the actual crop area ($Avail_{ij}$) that is available for each crop group $c$ in grid cell $i$. This equation extends the one in @You, by adding spatialy explicit information on the location of specific crops in the country.    


$$\sum_{j \in c} \sum_{l}CropArea_{jl} \times s_{ijl} \leq Avail_{ic} \qquad \forall i$$

(iv) A constraint [@ADD suitability equation]


$$CropArea_{jl} \times s_{ijl} \leq SuitArea_{ijl} \qquad \forall i \quad \forall j \quad\forall l$$

(v) A constraint, which ensures that the sum of allocated physical area over all production systems within a  sub-national geopolitical unit,$k=1,2,3,...$ (in this case administrative zone 2 level) is equal to the  physical area information ($SubCropArea_{jk}$) for commodities $J$ for which information is available from sub-national land use statistics. Crops for which only national level information is available are not affected by this constraint. 


$$\sum_{i\in k} \sum_{l}CropArea_{jl} \times s_{ijl} = SubCropArea_{jk} \qquad \forall k \quad \forall j \in J$$

(vi) A constraint, which allocates spatially explicit information on irrigated areas ($IRRArea_{ijl}$) for  irrigated crops ($J$) that belong to the irrigated crop system in grid cells $I$. In contrast to $You2014, who do not have crop specific irrigation area, we have detailed location and crop specific data on irrigated areas, which we incorporate in the spatial allocation model. 

$$CropArea_{jl} \times s_{ijl} = IRRArea_{ijl} \qquad \forall i \in I \quad \forall l = irrigated \quad \forall j \in N$$


## Calculation of priors
[TO ADD. At the moment I use population density but for the high-intensity we can follow the approach of @You2014]


# Data
We combined information from a number of different sources to run the model described above (see Table X for an overview). A key input for the analysis is a high resolution land cover map that provides detailed information on the location of agricultural production. Recently, several new land use and land cover maps were produced for Malawi that cover the period 1990-2010 [see @Haack2014 for a comparison]. We decided to use the maps produced by the FAO [@FAO] that is available for 2010. The advantage of this map in comparison to others is that it has a very high resolution of 30x30 meter and therefore provides spatially explicit information on the location of five crop groups (rice, tropical fruits, sugar cane, tea & coffee and other crops) in Malawi. We aggregated the map to a resolution of @X and calculated the physical area share for each crop group per grid cell $i$.

Statistics on actual land use at the national level were taken from @FAO and extended with data from @Add, @add and @add for the administrative zone two level. We follow the approach of @Wood-Sichra2016 and aggregate all crop statistics to a set of standardised crops and subsequently allign the subnational data with national statistics from FAO. We were able to collect subnational data for XX out of the XX crops that are cultivated in Malawi. Annex X provides more information on the prepartion of the crop statistics.

Similar to @You2014, we use @GAEZ suitability map, which can be mapped to the standardised crops (see @Wood-Sichra2016). [@or perhaps use IFPRI maps].

Finally, we used detailed information from the National irrigation master plan and investment framework [@Add], which presents a geo-referenced inventory of irrigation systems in Malawi, including the size of the irrigated area and crop, for the period @add. Where needed we compared and extended the inventory with data from @Add, which provides similar but less detailed information. As the irrigated production system in SPAM are defined as high-input system, we decided only to include the estate and large smallholder association estates and excluded small-scale farmer schemes. A comparison showed that the resulting area is comparable to @GMIA, which is used by @You2014 as input layer. To create the final irrigation map, we compared the FAO land cover map with the irrigation map and allocated the point data to grid cells with matching crops (i.e. sugar cane irrigated areas to sugar cane grid cells). Annex X provides more detailed information about the procedure. 


__Table 1: Data sources__

```{r Tab_data}

```


# Results




# Validation



# Discussion



# Conclusions

# ANNEX

## Irrigation
In order to allocated irrigated areas, detailed information on irrigated crop areas was taken from country reports, complemented by an internet search and validation. @WorldBank2010 presents information on irrigated projects, including name, crop, actual irrigated area and area equaiped for irrigation for Malawi, that draws on a survey down in 2001, which was updated for the period XX. The survey mainly covers commercial estate produciton. @Irrigation presents similar information but also includes a very large number of informal smallholder irrigation projects and, most importantly, includes the spartial coordinates of the project. The data is representative for the period XX. We assume that the data from @WorldBank2014 and @irrigation are representative for the years 2000 and 2010, respectively.

To create irrigation maps for the two period (Figure X), we used the following procedure. First, data from two sources was combined and names and location of irrigation projects harmonised to create one consistent database, including the spatial coordinates of the project. Second, we decided to only include commercial estates and large-scale farm projects, while excluding smallholder areas. This is in line with SPAM, where the irrigated farming system is defined as [@add]. This definition excludes smallholders that mostly likely operate low input irrigated systems. Moreover, data on smallholder projects is only available for the period 2010 from @irrigation and it is doubtful whether the information is complete. Including the smallholder information increases the total irrigated area to XX, which is also much higher than is used by GMIA and FAOSTAT, which also seem to include only large commercial production. Third, we validated the database by comparing the location of irrigation projects with (1) Open Street Map, which presents information of many sugar, tea and other crop estates, and (2) land cover maps from @FAO, which presents detailed information on tea, sugar, rice and other crop cover. There was considerable overlap between the sources but in a few cases, small errors (e.g the coordinates of the irrigation project) were corrected. Figure X shows the resulting maps of irrigation project in Malawi for 2000 and 2010. Fourth, the irrgation project map was rasterized on a 5x5 min grid that corresponds with the spatial allocation procedure. In order to do this we first added a buffer to point locations that is equal to the size of the irrigated area of the respective irrigation project and then allocated the irrigated area to the grid. Again the data was validated by comparing the result with Open Street Map and the actual crop cover from @FAO. For some large estates the buffered and rasterized area was inconsistent with the actual shape and location of the (irrigated) area. In all cases the problem could be fixed by manually relo


As also pointed out in the two aforementioned sources, it is important to note that the database of irrigated projects and resulting irrigation maps probably do not cover all (commercial) irrigated projects in Malawi and total irrigated area is probably underreported. Nonetheless, with X ha in 2000 and X in 2010 total area is similar to that presented in GMIA with XX ha. An overlay also illustrates that the maps are similar.

# Rice
We encountered a discrepancy betweeen the adm level statistics and crop cover map for rice. Although the harvested area is comparanle to the land cover at the national level, values differ at the adm level. For some adms, rice production was unrealistically and not in line with suitablily maps [IFPRI] and land cover maps which signal that rice is mainly located in the Eastern adm zones adjacent to lake malawi and lake [ADD]. For this reason we deciced to discard the regional statistics for rice and use the land cover map to allocate rice areas. A small remainder was allocated to crop areas. 


# land cover map
- combined teas and coffee as irrigated areas and osm demonstrated that large coffee estate was identified as tea estate
- use pure crop areas first plus areas with agri and build up and agri and orchards
- For some adm zones land cover was less than land use and we added agri plus trees etc

# ag stat
- missing for Nkhata bay. Used 2007 data but seems relatively high, careful interpretation